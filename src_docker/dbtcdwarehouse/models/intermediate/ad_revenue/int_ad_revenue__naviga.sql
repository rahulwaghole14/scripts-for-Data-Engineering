{{
  config(
        tags=['adw']
    )
}}

WITH sat_ad_revenue_naviga AS (

    SELECT *
    FROM {{ ref('sat_ad_revenue_naviga') }}
    QUALIFY DATE(LOAD_DATE) = MAX(DATE(LOAD_DATE)) OVER ()

)

, satdata AS (

    SELECT
        sat_ad_revenue_naviga.AD_REPORT_KEY
        , sat_ad_revenue_naviga.AD_REPORT_HASH
        , sat_ad_revenue_naviga.RECORD_SOURCE
        , CAST(AD_CAMPAIGN_ID AS STRING) AS CAMPAIGN_ID
        , CAST(AD_LINE_ID AS STRING) AS LINE_ID
        , CAST(AD_MONTH_UNIQUE_ID AS STRING) AS MONTH_UNIQUE_ID
        , SAFE_CAST(CASE
            WHEN AD_PRINT_PUB_IND = 'Y'
                THEN
                    CASE
                        WHEN AD_CAMPAIGN_ID = 34896 THEN AD_MONTH_START_DATE
                        WHEN AD_ISSUE_DATE IS NULL THEN AD_DATE_ENTERED
                        ELSE AD_ISSUE_DATE
                    END
            ELSE AD_MONTH_START_DATE
        END AS DATE) AS DATE
        , SAFE_CAST(AD_DATE_ENTERED AS DATE) AS DATE_ENTERED
        , CASE
            WHEN AD_PRINT_PUB_IND = 'Y' THEN 'Print'
            WHEN AD_PRINT_PUB_IND = 'N' THEN 'Digital'
            ELSE '(not set)'
        END AS ORIGIN
        , 'Naviga' AS SOURCE
        , CASE
            WHEN AD_CURRENT_REP_NAME LIKE '%Lenora%' THEN 'Regional Sales - Waikato'
            ELSE AD_PRIMARY_REP_GROUP
        END AS PRIMARY_REP_GROUP
        , 'Naviga' AS SOURCE_OR_GL
        , CAST(AD_AGENCY_LEGACY AS STRING) AS AGENCY_LEGACY
        , CAST(AD_ADVERTISER_ID AS STRING) AS ADVERTISER_ID
        , CAST(AD_ADVERTISER_LEGACY AS STRING) AS ADVERTISER_LEGACY
        , CASE
            WHEN AD_ADVERTISER_LEGACY IS null THEN CAST(AD_ADVERTISER_ID AS STRING)
            ELSE CAST(AD_ADVERTISER_LEGACY AS STRING)
        END AS CUSTOMERNUMBER
        , AD_ADVERTISER_NAME AS ADVERTISER_NAME
        , AD_PIB_CATEGORY_DESC AS PIB_CATEGORY_DESC
        , AD_AGENCY_NAME AS AGENCY_NAME
        , AD_PRODUCT_NAME AS PRODUCT_NAME
        , CAST(AD_PRODUCT_ID AS STRING) AS PRODUCT_ID
        , AD_SIZE_DESC AS SIZE_DESC
        , AD_AD_TYPE_ID AS AD_TYPE_ID
        , CAST(REPLACE(AD_GROSS_LINE_LOCAL_AMOUNT, ',', '') AS FLOAT64) AS GROSS_LINE_LOCAL_AMOUNT
        , CAST(REPLACE(AD_NET_LINE_LOCAL_AMOUNT, ',', '') AS FLOAT64) AS REVENUE
        , CAST(AD_FILEUPDATEDATETIME AS STRING) AS FILEUPDATEDATETIME
        , AD_GL_TYPE_ID AS GL_TYPE_ID
        , AD_GL_TYPES_DESCRIPTION AS GL_TYPES_DESCRIPTION
        , CASE
            WHEN AD_CLIENT_TYPE_ID = 'HOUSE' THEN 'House Ads'
            WHEN AD_ADVERTISER_NAME LIKE 'CONTRA%' THEN 'Contra'
            WHEN AD_ADVERTISER_NAME LIKE 'Marketing' THEN 'House Ads'
            ELSE 'Paid Advertising (excl House and Contra)'
        END AS PAID_ADVERTISING
        , CASE
            WHEN AD_CURRENT_REP_NAME = 'Kelly Wiley-Sharland' THEN 'Kelly Sharland-Wiley'
            ELSE AD_CURRENT_REP_NAME
        END AS CURRENT_REP_NAME
        , CASE
            WHEN AD_PRODUCT_NAME = 'hexa.co.nz' THEN 'hexa'
            WHEN AD_PRODUCT_NAME = 'Audio Media' THEN 'Audio'
            WHEN AD_PRODUCT_NAME = 'Neighbourly' THEN 'Neighbourly'
            WHEN AD_PRODUCT_NAME = 'OTHER' THEN 'Other' ELSE 'Print'
        END AS PLATFORM
        , CASE
            WHEN AD_GL_TYPE_ID = 'AUD' THEN 'Audio'
            WHEN AD_GL_TYPE_ID = 'INS' THEN 'Insert'
            WHEN AD_GL_TYPE_ID = 'DIGI' THEN 'Digital Ads'
            WHEN AD_GL_TYPE_ID = 'CLAS' THEN 'Classifieds'
            WHEN AD_GL_TYPE_ID = 'NBLY' THEN 'Neighbourly'
            WHEN AD_GL_TYPE_ID = 'PRCH' THEN 'Production Charge'
            WHEN AD_GL_TYPE_ID = 'Pre Roll' THEN 'Video'
            WHEN AD_GL_TYPE_ID = 'Video' THEN 'Video'
            ELSE AD_GL_TYPES_DESCRIPTION
        END AS PRODUCT_TYPE
        , CAST(AD_PRIMARY_GROUP_ID AS STRING) AS PRIMARY_GROUP_ID
        , CAST(AD_CLIENT_TYPE_ID AS STRING) AS CLIENT_TYPE_ID
        , CAST(AD_CAMPAIGN_TYPE AS STRING) AS CAMPAIGN_TYPE
        , CAST(AD_CAMPAIGN_STATUS_CODE AS STRING) AS CAMPAIGN_STATUS_CODE
        , CAST(AD_LINE_CANCEL_STATUS_ID AS STRING) AS LINE_CANCEL_STATUS_ID
        , CAST(AD_CURRENCY_EXCHANGE_RATE AS STRING) AS CURRENCY_EXCHANGE_RATE
        , CAST(AD_CURRENCY_CODE AS STRING) AS CURRENCY_CODE
        , SAFE_CAST(AD_AGENCY_COMMISSION_PERCENT AS FLOAT64) AS AGENCY_COMMISSION_PERCENT
        , CAST(AD_NO_AGY_COMM_IND AS STRING) AS NO_AGY_COMM_IND
        , CAST(REPLACE(AD_ACTUAL_LINE_LOCAL_AMOUNT, ',', '') AS FLOAT64) AS ACTUAL_LINE_LOCAL_AMOUNT
        , CAST(REPLACE(AD_EST_LINE_LOCAL_AMOUNT, ',', '') AS FLOAT64) AS EST_LINE_LOCAL_AMOUNT
        , CAST(REPLACE(AD_GROSS_LINE_FOREIGN_AMOUNT, ',', '') AS FLOAT64) AS GROSS_LINE_FOREIGN_AMOUNT
        , CAST(REPLACE(AD_NET_LINE_FOREIGN_AMOUNT, ',', '') AS FLOAT64) AS NET_LINE_FOREIGN_AMOUNT
        , CAST(AD_CURRENT_REP_ID AS STRING) AS CURRENT_REP_ID
        , CAST(AD_CURRENT_REP_PCT AS STRING) AS CURRENT_REP_PCT
        , CAST(AD_NET_REP_AMOUNT AS STRING) AS NET_REP_AMOUNT
        , CAST(AD_MONTH_ACTUAL_AMT AS STRING) AS MONTH_ACTUAL_AMT
        , CAST(AD_MONTH_EST_AMT AS STRING) AS MONTH_EST_AMT
        , CAST(AD_PRODUCT_GROUPING AS STRING) AS PRODUCT_GROUPING
        , CAST(AD_PRIMARY_REP_GROUP_ID AS STRING) AS PRIMARY_REP_GROUP_ID
        , CAST(AD_AGENCY_ID AS STRING) AS AGENCY_ID
        , CAST(AD_AD_INTERNET_CAMPAIGNS_BRAND_ID AS STRING) AS AD_INTERNET_CAMPAIGNS_BRAND_ID
        , CAST(AD_BRAND_PIB_CODE AS STRING) AS BRAND_PIB_CODE
        , CAST(AD_AD_INTERNET_SECTIONS_SECTION_DESCRIPTION AS STRING) AS SECTION
        , CAST(AD_EST_QTY AS STRING) AS EST_QTY
        , CAST(AD_MONTH_ACTUAL_IMPS AS STRING) AS MONTH_ACTUAL_IMPS
    FROM {{ ref('hub_ad_revenue') }} hub_ad_revenue
    INNER JOIN sat_ad_revenue_naviga ON (sat_ad_revenue_naviga.AD_REPORT_HASH = hub_ad_revenue.AD_REPORT_HASH)

)

SELECT * FROM satdata
